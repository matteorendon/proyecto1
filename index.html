<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maqueta ML - MVP</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>Optimización de decisiones laborales (MVP)</h1>
    <p class="subtitle">Sistema demostrativo basado en Machine Learning supervisado — UNAD</p>
  </header>

  <main class="container">

    <!-- ==========================
      SECCIÓN: INGRESO DE DATOS
    ============================ -->
    <section class="card">
      <h2>Agregar dato (RRHH / Operaciones / Finanzas)</h2>
      <div class="form-row">
        <select id="area">
          <option value="rrhh">Recursos Humanos</option>
          <option value="ops">Operaciones</option>
          <option value="fin">Finanzas</option>
        </select>
        <input id="metric" placeholder="Métrica (ej: ausentismo)">
        <input id="value" type="number" placeholder="Valor numérico">
        <button id="addBtn">Agregar</button>
      </div>
    </section>

    <!-- ==========================
      SECCIÓN: UMBRAL SEMÁFORO
    ============================ -->
    <section class="card">
      <h2>Regla de interpretación (Semáforo)</h2>
      <p>Define un umbral para clasificar el escenario esperado:</p>
      <div class="form-row">
          <input id="threshold" type="number" placeholder="Umbral (por ejemplo: 50)">
          <button id="saveThreshold">Guardar umbral</button>
      </div>
      <div id="currentThreshold" class="muted">Sin umbral establecido</div>
    </section>

    <!-- ==========================
      SECCIÓN: EJECUCIÓN DEL MODELO
    ============================ -->
    <section class="card">
      <h2>Simulación del modelo</h2>
      <div class="form-row">
        <button id="runModel">Ejecutar modelo</button>
        <button id="retrain">Reentrenar (retroalimentación)</button>
        <button id="clearData">Borrar datos</button>
      </div>
      <div id="alerts" class="alerts"></div>
    </section>

    <!-- ==========================
      SECCIÓN: GRÁFICA
    ============================ -->
    <section class="card fullwidth">
      <h2>Escenarios (Gráfica)</h2>
      <canvas id="scenarioChart"></canvas>
    </section>

    <!-- ==========================
      TABLA DE DATOS
    ============================ -->
    <section class="card">
      <h2>Datos ingresados</h2>
      <table id="dataTable" class="table">
        <thead><tr><th>Área</th><th>Métrica</th><th>Valor</th><th>TS</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <footer>
    <small>Proyecto MVP — Machine Learning Supervisado</small>
  </footer>

<script src="storage.js"></script>
<script src="model.js"></script>
<script src="charts.js"></script>

<script>
(function(){
  // Referencias
  const dataTableBody = document.querySelector('#dataTable tbody');
  const alertsDiv = document.getElementById('alerts');

  // ==========================
  // TABLA
  // ==========================
  function refreshTable(){
    const arr = Storage.getAll();
    dataTableBody.innerHTML = '';
    arr.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.area}</td><td>${r.metric}</td><td>${r.value}</td><td>${new Date(r.ts).toLocaleString()}</td>`;
      dataTableBody.appendChild(tr);
    });
  }

  // ==========================
  // SECCIÓN MODELO
  // ==========================
  function runModel(){
    const data = Storage.getAll();
    const sim = Model.simulate(data);
    ChartModule.renderScenarioChart(sim);

    // clasificación semáforo
    const expectedFinal = sim.expected[sim.expected.length - 1];
    const threshold = Storage.getThreshold();
    const cls = ModelColor.classify(expectedFinal, threshold);

    alertsDiv.innerHTML = `<div class="alert ${cls.color}">${cls.msg}</div>`;
  }

  // ==========================
  // EVENTOS
  // ==========================
  document.getElementById('addBtn').onclick = ()=>{
    const area = document.getElementById('area').value;
    const metric = document.getElementById('metric').value.trim();
    const value = parseFloat(document.getElementById('value').value);
    if(!metric || isNaN(value)) return alert('Completa métrica y valor');
    Storage.addEntry({ area, metric, value, ts: Date.now() });
    refreshTable();
  };

  document.getElementById('runModel').onclick = runModel;

  document.getElementById('clearData').onclick = ()=>{
    if(confirm("¿Borrar todo?")){
      Storage.clearAll();
      refreshTable();
      alertsDiv.innerHTML = '';
      if(ChartModule.chart) ChartModule.chart.destroy();
      refreshThreshold();
    }
  };

  document.getElementById('retrain').onclick = ()=>{
    alert("Reentrenamiento simulado completado.");
    runModel();
  };

  // ==========================
  // UMBRAL
  // ==========================
  const saveThresholdBtn = document.getElementById('saveThreshold');
  const thresholdInput = document.getElementById('threshold');
  const currentThDiv = document.getElementById('currentThreshold');

  function refreshThreshold(){
    const th = Storage.getThreshold();
    currentThDiv.textContent = th !== null ? `Umbral actual: ${th}` : "Sin umbral establecido";
  }

  saveThresholdBtn.onclick = ()=>{
    const value = parseFloat(thresholdInput.value);
    if(isNaN(value)) return alert("Ingresa un número válido");
    Storage.setThreshold(value);
    refreshThreshold();
  };

  refreshThreshold();
  refreshTable();
})();
</script>

</body>
</html>
